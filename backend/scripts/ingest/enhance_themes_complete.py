#!/usr/bin/env python3
"""
Complete Quranic Themes Enhancement Script
Populates themes with verses and creates proper relationships.
"""

import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from sqlalchemy import create_engine, text
from app.core.config import settings

# Complete themes with ID format, verses, and relationships
THEMES_DATA = {
    # Existing themes - add verses
    "tawhid": {
        "name_ar": "التوحيد",
        "name_en": "Monotheism (Tawhid)",
        "description_ar": "الإيمان بوحدانية الله في ذاته وصفاته وأفعاله",
        "description_en": "Belief in the absolute oneness of Allah",
        "verses": [
            (2, 163), (2, 255), (3, 2), (3, 18), (6, 102), (6, 103),
            (7, 54), (20, 8), (20, 14), (21, 22), (23, 91), (28, 88),
            (39, 4), (57, 3), (59, 22), (59, 23), (59, 24), (112, 1),
            (112, 2), (112, 3), (112, 4)
        ],
        "related": ["iman", "taqwa"]
    },
    "sabr": {
        "name_ar": "الصبر",
        "name_en": "Patience (Sabr)",
        "description_ar": "التحمل والثبات عند الشدائد والمصائب",
        "description_en": "Patience and steadfastness in trials",
        "verses": [
            (2, 45), (2, 153), (2, 155), (2, 156), (2, 157), (2, 177),
            (3, 17), (3, 120), (3, 125), (3, 186), (3, 200), (7, 87),
            (7, 126), (7, 128), (7, 137), (8, 46), (8, 66), (10, 109),
            (11, 11), (11, 49), (11, 115), (12, 18), (12, 83), (12, 90),
            (13, 22), (14, 12), (16, 42), (16, 96), (16, 110), (16, 126),
            (16, 127), (18, 28), (20, 130), (21, 85), (22, 35), (23, 111),
            (25, 75), (28, 54), (29, 59), (30, 60), (31, 17), (32, 24),
            (33, 35), (37, 102), (38, 44), (39, 10), (40, 55), (40, 77),
            (41, 35), (42, 33), (42, 43), (46, 35), (47, 31), (50, 39),
            (52, 48), (68, 48), (70, 5), (73, 10), (74, 7), (76, 12),
            (90, 17), (103, 3)
        ],
        "related": ["tawakkul", "shukr", "taqwa"]
    },
    "tawakkul": {
        "name_ar": "التوكل",
        "name_en": "Trust in Allah (Tawakkul)",
        "description_ar": "الاعتماد على الله مع الأخذ بالأسباب",
        "description_en": "Reliance on Allah while taking necessary means",
        "verses": [
            (3, 122), (3, 159), (3, 160), (3, 173), (4, 81), (5, 11),
            (5, 23), (7, 89), (8, 2), (8, 49), (9, 51), (9, 129),
            (10, 71), (10, 84), (10, 85), (11, 56), (11, 88), (11, 123),
            (12, 67), (13, 30), (14, 11), (14, 12), (16, 42), (16, 99),
            (25, 58), (26, 217), (27, 79), (29, 59), (33, 3), (33, 48),
            (39, 38), (42, 10), (42, 36), (58, 10), (60, 4), (64, 13),
            (65, 3), (67, 29)
        ],
        "related": ["sabr", "iman", "taqwa"]
    },
    "tawbah": {
        "name_ar": "التوبة",
        "name_en": "Repentance (Tawbah)",
        "description_ar": "الرجوع إلى الله والندم على الذنوب",
        "description_en": "Returning to Allah and regretting sins",
        "verses": [
            (2, 37), (2, 54), (2, 128), (2, 160), (2, 187), (2, 222),
            (3, 89), (3, 90), (3, 135), (4, 17), (4, 18), (4, 26),
            (4, 27), (4, 64), (4, 92), (4, 146), (5, 34), (5, 39),
            (5, 71), (5, 74), (6, 54), (7, 143), (7, 153), (9, 3),
            (9, 5), (9, 11), (9, 74), (9, 102), (9, 104), (9, 112),
            (9, 117), (9, 118), (11, 3), (11, 52), (11, 61), (11, 90),
            (13, 27), (16, 119), (17, 25), (19, 60), (20, 82), (20, 122),
            (24, 5), (24, 31), (25, 70), (25, 71), (28, 67), (39, 53),
            (39, 54), (40, 3), (42, 25), (46, 15), (49, 11), (50, 32),
            (50, 33), (57, 28), (58, 13), (66, 8), (73, 20), (85, 10),
            (110, 3)
        ],
        "related": ["rahma", "maghfira", "istighfar"]
    },
    "taqwa": {
        "name_ar": "التقوى",
        "name_en": "God-consciousness (Taqwa)",
        "description_ar": "خشية الله والعمل بطاعته واجتناب معصيته",
        "description_en": "Consciousness of Allah through obedience",
        "verses": [
            (2, 2), (2, 21), (2, 41), (2, 63), (2, 66), (2, 103), (2, 177),
            (2, 179), (2, 183), (2, 189), (2, 194), (2, 196), (2, 197),
            (2, 203), (2, 206), (2, 212), (2, 223), (2, 224), (2, 231),
            (2, 233), (2, 237), (2, 241), (2, 278), (2, 281), (2, 282),
            (2, 283), (3, 15), (3, 50), (3, 76), (3, 102), (3, 120),
            (3, 123), (3, 125), (3, 130), (3, 131), (3, 133), (3, 138),
            (3, 172), (3, 179), (3, 186), (3, 198), (3, 200), (4, 1),
            (4, 9), (4, 77), (4, 129), (4, 131), (5, 2), (5, 4), (5, 7),
            (5, 8), (5, 11), (5, 27), (5, 35), (5, 57), (5, 65), (5, 88),
            (5, 93), (5, 96), (5, 100), (5, 108), (5, 112), (6, 32),
            (6, 51), (6, 69), (6, 72), (6, 153), (6, 155), (7, 26),
            (7, 35), (7, 63), (7, 65), (7, 96), (7, 128), (7, 154),
            (7, 156), (7, 164), (7, 169), (7, 171), (7, 201), (8, 1),
            (8, 25), (8, 29), (8, 34), (8, 56), (8, 69), (9, 4), (9, 7),
            (9, 36), (9, 44), (9, 108), (9, 109), (9, 115), (9, 123),
            (10, 6), (10, 31), (10, 63), (11, 78), (12, 57), (12, 90),
            (12, 109), (13, 35), (14, 26), (15, 45), (16, 2), (16, 30),
            (16, 31), (16, 52), (16, 81), (16, 128), (17, 57), (18, 31),
            (19, 13), (19, 18), (19, 63), (19, 72), (19, 85), (19, 97),
            (20, 113), (20, 132), (21, 48), (22, 1), (22, 32), (22, 37),
            (23, 23), (23, 32), (23, 52), (23, 87), (24, 34), (24, 52),
            (25, 15), (26, 11), (26, 90), (26, 106), (26, 108), (26, 110),
            (26, 124), (26, 126), (26, 131), (26, 132), (26, 142), (26, 144),
            (26, 150), (26, 161), (26, 163), (26, 177), (26, 179), (26, 184),
            (27, 53), (28, 83), (29, 16), (30, 31), (31, 33), (32, 16),
            (33, 1), (33, 32), (33, 55), (33, 70), (34, 37), (35, 28),
            (36, 11), (37, 124), (38, 28), (38, 49), (39, 10), (39, 20),
            (39, 28), (39, 33), (39, 57), (39, 61), (39, 73), (40, 9),
            (41, 18), (43, 35), (43, 63), (43, 67), (44, 51), (45, 19),
            (47, 15), (47, 17), (47, 36), (48, 5), (48, 26), (49, 1),
            (49, 3), (49, 10), (49, 12), (49, 13), (50, 31), (51, 15),
            (52, 17), (54, 54), (57, 28), (58, 9), (59, 7), (59, 18),
            (60, 11), (64, 16), (65, 1), (65, 2), (65, 4), (65, 5),
            (65, 10), (67, 12), (68, 34), (69, 48), (71, 3), (72, 13),
            (73, 17), (74, 56), (76, 11), (78, 31), (79, 40), (80, 32),
            (87, 10), (91, 8), (92, 5), (92, 17), (96, 12), (98, 8)
        ],
        "related": ["iman", "ihsan", "khushu"]
    },
    "shukr": {
        "name_ar": "الشكر",
        "name_en": "Gratitude (Shukr)",
        "description_ar": "الاعتراف بنعم الله وشكره عليها",
        "description_en": "Acknowledging and thanking Allah for His blessings",
        "verses": [
            (2, 52), (2, 56), (2, 152), (2, 158), (2, 172), (2, 185),
            (2, 243), (3, 123), (3, 144), (3, 145), (4, 147), (5, 6),
            (5, 89), (7, 10), (7, 17), (7, 58), (7, 144), (7, 189),
            (8, 26), (10, 22), (10, 60), (12, 38), (14, 5), (14, 7),
            (14, 37), (16, 14), (16, 78), (16, 114), (16, 121), (17, 3),
            (21, 80), (22, 36), (23, 78), (25, 62), (27, 15), (27, 19),
            (27, 40), (27, 73), (28, 73), (29, 17), (29, 66), (30, 46),
            (31, 12), (31, 14), (31, 31), (34, 13), (34, 15), (34, 17),
            (34, 19), (35, 12), (35, 34), (36, 35), (36, 73), (37, 35),
            (39, 7), (39, 66), (40, 61), (42, 33), (45, 12), (46, 15),
            (54, 35), (55, 78), (56, 70), (64, 17), (67, 23), (76, 3)
        ],
        "related": ["sabr", "rahma", "rizq"]
    },
    "adl": {
        "name_ar": "العدل",
        "name_en": "Justice (Adl)",
        "description_ar": "إعطاء كل ذي حق حقه",
        "description_en": "Giving everyone their due rights",
        "verses": [
            (2, 282), (3, 18), (4, 3), (4, 58), (4, 105), (4, 127),
            (4, 129), (4, 135), (5, 8), (5, 42), (5, 95), (5, 106),
            (6, 115), (6, 152), (7, 29), (7, 181), (10, 4), (10, 47),
            (10, 54), (11, 85), (16, 76), (16, 90), (21, 47), (26, 182),
            (38, 26), (42, 15), (49, 9), (55, 9), (57, 25), (60, 8)
        ],
        "related": ["ihsan", "amanah", "qist"]
    },
    "ihsan": {
        "name_ar": "الإحسان",
        "name_en": "Excellence (Ihsan)",
        "description_ar": "أن تعبد الله كأنك تراه",
        "description_en": "Worshipping Allah as if you see Him",
        "verses": [
            (2, 58), (2, 112), (2, 195), (2, 236), (3, 134), (3, 148),
            (4, 36), (4, 62), (4, 125), (4, 128), (5, 13), (5, 85),
            (5, 93), (6, 84), (6, 154), (7, 56), (7, 161), (9, 91),
            (9, 100), (9, 120), (10, 26), (11, 115), (12, 22), (12, 36),
            (12, 56), (12, 78), (12, 90), (16, 30), (16, 90), (16, 125),
            (16, 128), (17, 7), (17, 23), (18, 30), (22, 37), (28, 14),
            (28, 77), (29, 69), (31, 3), (31, 22), (33, 29), (37, 80),
            (37, 105), (37, 110), (37, 113), (37, 121), (37, 131), (39, 10),
            (39, 34), (39, 58), (41, 34), (46, 12), (51, 16), (53, 31),
            (55, 60), (77, 44)
        ],
        "related": ["taqwa", "adl", "sidq"]
    },
    "sidq": {
        "name_ar": "الصدق",
        "name_en": "Truthfulness (Sidq)",
        "description_ar": "المطابقة بين القول والفعل والظاهر والباطن",
        "description_en": "Alignment between words, actions, and intentions",
        "verses": [
            (2, 177), (3, 17), (3, 77), (3, 95), (4, 69), (4, 87),
            (4, 122), (5, 75), (5, 119), (6, 115), (7, 105), (9, 43),
            (9, 119), (10, 2), (12, 17), (12, 26), (12, 27), (12, 46),
            (12, 51), (17, 80), (19, 41), (19, 50), (19, 54), (19, 56),
            (22, 78), (26, 84), (28, 34), (29, 3), (33, 8), (33, 22),
            (33, 23), (33, 24), (33, 35), (38, 84), (39, 32), (39, 33),
            (46, 16), (47, 21), (49, 15), (54, 55), (57, 19)
        ],
        "related": ["amanah", "wafa", "ihsan"]
    },
    "amanah": {
        "name_ar": "الأمانة",
        "name_en": "Trustworthiness (Amanah)",
        "description_ar": "حفظ ما اؤتمن عليه الإنسان",
        "description_en": "Preserving what one is entrusted with",
        "verses": [
            (2, 283), (3, 75), (3, 161), (4, 58), (8, 27), (12, 54),
            (12, 55), (23, 8), (26, 107), (26, 125), (26, 143), (26, 162),
            (26, 178), (27, 39), (28, 26), (33, 72), (44, 18), (70, 32),
            (81, 21)
        ],
        "related": ["sidq", "wafa", "adl"]
    },
    # New essential themes
    "iman": {
        "name_ar": "الإيمان",
        "name_en": "Faith (Iman)",
        "description_ar": "التصديق بالقلب والإقرار باللسان والعمل بالجوارح",
        "description_en": "Belief in heart, affirmation by tongue, action by limbs",
        "verses": [
            (2, 3), (2, 4), (2, 8), (2, 62), (2, 82), (2, 136), (2, 177),
            (2, 285), (3, 16), (3, 52), (3, 84), (3, 110), (3, 173),
            (4, 136), (4, 162), (5, 1), (5, 54), (6, 82), (7, 2),
            (8, 2), (8, 3), (8, 4), (9, 18), (9, 71), (9, 112),
            (10, 9), (10, 63), (13, 28), (16, 97), (18, 30), (22, 14),
            (23, 1), (32, 15), (33, 35), (41, 8), (42, 26), (47, 2),
            (48, 4), (49, 7), (49, 14), (49, 15), (57, 8), (57, 19),
            (58, 22), (64, 8), (72, 13), (103, 3)
        ],
        "related": ["tawhid", "taqwa", "salah"]
    },
    "rahma": {
        "name_ar": "الرحمة",
        "name_en": "Mercy (Rahma)",
        "description_ar": "رقة القلب والعطف على الخلق",
        "description_en": "Tenderness of heart and compassion for creation",
        "verses": [
            (1, 1), (1, 3), (2, 64), (2, 105), (2, 157), (2, 163),
            (2, 178), (2, 218), (3, 8), (3, 74), (3, 132), (3, 157),
            (4, 83), (4, 96), (4, 113), (4, 175), (5, 54), (6, 12),
            (6, 16), (6, 54), (6, 133), (6, 147), (6, 154), (6, 155),
            (6, 157), (7, 52), (7, 56), (7, 63), (7, 72), (7, 151),
            (7, 154), (7, 156), (7, 203), (9, 21), (9, 99), (10, 21),
            (10, 57), (10, 58), (10, 86), (11, 17), (11, 28), (11, 58),
            (11, 63), (11, 66), (11, 73), (11, 94), (11, 119), (12, 53),
            (12, 56), (12, 111), (15, 56), (16, 64), (16, 89), (17, 24),
            (17, 54), (17, 57), (17, 82), (17, 87), (17, 100), (18, 58),
            (18, 65), (18, 82), (18, 98), (19, 2), (19, 13), (19, 21),
            (19, 50), (19, 53), (21, 75), (21, 84), (21, 86), (21, 107),
            (23, 109), (23, 118), (24, 10), (24, 14), (24, 20), (24, 21),
            (25, 48), (26, 9), (27, 63), (27, 77), (28, 43), (28, 46),
            (28, 73), (29, 23), (29, 51), (30, 21), (30, 33), (30, 36),
            (30, 46), (30, 50), (31, 3), (33, 43), (33, 47), (34, 2),
            (35, 2), (36, 44), (36, 58), (38, 9), (38, 43), (39, 9),
            (39, 38), (39, 53), (40, 7), (42, 8), (42, 28), (43, 32),
            (44, 6), (44, 42), (45, 20), (45, 30), (46, 8), (48, 25),
            (48, 29), (57, 13), (57, 27), (57, 28), (59, 10), (59, 22),
            (66, 1), (67, 2), (76, 31)
        ],
        "related": ["maghfira", "tawbah", "ihsan"]
    },
    "salah": {
        "name_ar": "الصلاة",
        "name_en": "Prayer (Salah)",
        "description_ar": "الركن الثاني من أركان الإسلام",
        "description_en": "The second pillar of Islam - ritual prayer",
        "verses": [
            (2, 3), (2, 43), (2, 45), (2, 83), (2, 110), (2, 153),
            (2, 177), (2, 238), (2, 277), (4, 43), (4, 77), (4, 101),
            (4, 102), (4, 103), (4, 142), (4, 162), (5, 6), (5, 12),
            (5, 55), (5, 58), (5, 91), (5, 106), (6, 72), (6, 92),
            (6, 162), (7, 29), (7, 170), (8, 3), (9, 5), (9, 11),
            (9, 18), (9, 54), (9, 71), (9, 103), (10, 87), (11, 87),
            (11, 114), (13, 22), (14, 31), (14, 37), (14, 40), (17, 78),
            (17, 79), (17, 110), (19, 31), (19, 55), (19, 59), (20, 14),
            (20, 132), (21, 73), (22, 35), (22, 41), (22, 78), (23, 2),
            (23, 9), (24, 37), (24, 41), (24, 56), (24, 58), (27, 3),
            (29, 45), (30, 31), (31, 4), (31, 17), (33, 33), (35, 18),
            (35, 29), (42, 38), (58, 13), (62, 9), (62, 10), (70, 22),
            (70, 23), (70, 34), (73, 20), (74, 43), (75, 31), (87, 15),
            (96, 10), (98, 5), (107, 4), (107, 5), (108, 2)
        ],
        "related": ["zakat", "iman", "taqwa"]
    },
    "zakat": {
        "name_ar": "الزكاة",
        "name_en": "Almsgiving (Zakat)",
        "description_ar": "الركن الثالث من أركان الإسلام",
        "description_en": "The third pillar of Islam - obligatory charity",
        "verses": [
            (2, 43), (2, 83), (2, 110), (2, 177), (2, 277), (4, 77),
            (4, 162), (5, 12), (5, 55), (7, 156), (9, 5), (9, 11),
            (9, 18), (9, 60), (9, 71), (9, 103), (19, 31), (19, 55),
            (21, 73), (22, 41), (22, 78), (23, 4), (24, 37), (24, 56),
            (27, 3), (30, 39), (31, 4), (33, 33), (41, 7), (58, 13),
            (73, 20), (98, 5)
        ],
        "related": ["salah", "sadaqah", "infaq"]
    },
    "sawm": {
        "name_ar": "الصيام",
        "name_en": "Fasting (Sawm)",
        "description_ar": "الركن الرابع من أركان الإسلام",
        "description_en": "The fourth pillar of Islam - fasting",
        "verses": [
            (2, 183), (2, 184), (2, 185), (2, 187), (2, 196), (4, 92),
            (5, 89), (5, 95), (19, 26), (33, 35), (58, 4), (66, 5)
        ],
        "related": ["taqwa", "sabr", "ramadan"]
    },
    "hajj": {
        "name_ar": "الحج",
        "name_en": "Pilgrimage (Hajj)",
        "description_ar": "الركن الخامس من أركان الإسلام",
        "description_en": "The fifth pillar of Islam - pilgrimage to Mecca",
        "verses": [
            (2, 158), (2, 189), (2, 196), (2, 197), (2, 198), (2, 199),
            (2, 200), (2, 201), (2, 203), (3, 97), (5, 1), (5, 2),
            (5, 95), (5, 96), (5, 97), (9, 3), (9, 19), (22, 26),
            (22, 27), (22, 28), (22, 29), (22, 30), (22, 31), (22, 32),
            (22, 33), (22, 34), (22, 36), (22, 37), (48, 25), (48, 27)
        ],
        "related": ["umrah", "kabah", "ibrahim"]
    },
    "dhikr": {
        "name_ar": "الذكر",
        "name_en": "Remembrance of Allah (Dhikr)",
        "description_ar": "ذكر الله باللسان والقلب",
        "description_en": "Remembrance of Allah with tongue and heart",
        "verses": [
            (2, 152), (2, 198), (2, 200), (2, 203), (3, 41), (3, 135),
            (3, 191), (4, 103), (4, 142), (5, 91), (7, 55), (7, 180),
            (7, 201), (7, 205), (8, 2), (8, 45), (13, 28), (17, 110),
            (18, 24), (18, 28), (20, 14), (20, 34), (20, 42), (22, 28),
            (22, 34), (22, 36), (24, 36), (24, 37), (26, 227), (29, 45),
            (33, 9), (33, 21), (33, 35), (33, 41), (33, 42), (39, 22),
            (39, 23), (43, 36), (57, 16), (62, 10), (63, 9), (73, 8),
            (76, 25), (87, 15)
        ],
        "related": ["salah", "dua", "quran"]
    },
    "dua": {
        "name_ar": "الدعاء",
        "name_en": "Supplication (Dua)",
        "description_ar": "التضرع إلى الله وطلب الحاجات منه",
        "description_en": "Beseeching Allah and asking for needs",
        "verses": [
            (1, 5), (2, 186), (2, 201), (3, 8), (3, 38), (3, 147),
            (3, 193), (3, 194), (6, 40), (6, 41), (6, 63), (7, 29),
            (7, 55), (7, 56), (7, 180), (10, 12), (10, 22), (10, 106),
            (13, 14), (14, 39), (14, 40), (14, 41), (17, 11), (19, 4),
            (19, 48), (21, 76), (21, 83), (21, 87), (21, 89), (21, 90),
            (23, 97), (23, 98), (25, 65), (25, 74), (27, 62), (29, 65),
            (40, 14), (40, 60), (40, 65), (46, 5), (71, 10), (71, 28),
            (113, 1), (114, 1)
        ],
        "related": ["dhikr", "tawakkul", "rahma"]
    }
}


def main():
    engine = create_engine(settings.database_url)

    with engine.connect() as conn:
        created = 0
        updated = 0
        verses_added = 0

        for theme_id, data in THEMES_DATA.items():
            # Check if theme exists
            result = conn.execute(
                text("SELECT id FROM themes WHERE id = :id"),
                {"id": theme_id}
            ).fetchone()

            if result:
                print(f"Updating theme: {theme_id}")
                conn.execute(
                    text("""UPDATE themes SET
                        description_ar = :desc_ar,
                        description_en = :desc_en,
                        related_themes = :related
                        WHERE id = :id"""),
                    {"desc_ar": data["description_ar"],
                     "desc_en": data["description_en"],
                     "related": data.get("related", []),
                     "id": theme_id}
                )
                updated += 1
            else:
                print(f"Creating theme: {theme_id}")
                conn.execute(
                    text("""INSERT INTO themes (id, name_ar, name_en, description_ar, description_en, related_themes)
                        VALUES (:id, :name_ar, :name_en, :desc_ar, :desc_en, :related)"""),
                    {"id": theme_id,
                     "name_ar": data["name_ar"],
                     "name_en": data["name_en"],
                     "desc_ar": data["description_ar"],
                     "desc_en": data["description_en"],
                     "related": data.get("related", [])}
                )
                created += 1

            # Add verse associations
            for surah, ayah in data.get("verses", []):
                verse = conn.execute(
                    text("SELECT id FROM verses WHERE surah_num = :s AND ayah_num = :a"),
                    {"s": surah, "a": ayah}
                ).fetchone()

                if verse:
                    exists = conn.execute(
                        text("SELECT 1 FROM verse_themes WHERE verse_id = :v AND theme_id = :t"),
                        {"v": verse[0], "t": theme_id}
                    ).fetchone()

                    if not exists:
                        conn.execute(
                            text("INSERT INTO verse_themes (verse_id, theme_id) VALUES (:v, :t)"),
                            {"v": verse[0], "t": theme_id}
                        )
                        verses_added += 1

        conn.commit()
        print(f"\nComplete: Created {created}, Updated {updated}, Verses added {verses_added}")

if __name__ == "__main__":
    main()
