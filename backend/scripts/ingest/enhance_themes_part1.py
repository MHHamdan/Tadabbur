#!/usr/bin/env python3
"""
Quranic Themes Enhancement Script - Part 1: Core Theological Themes
Populates themes with verses, consequences, and relationships.
"""

import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from sqlalchemy import create_engine, text
from app.core.config import settings

# Core theological themes with their verses and relationships
CORE_THEMES = {
    "توحيد": {  # Tawhid - Oneness of Allah
        "name_en": "Tawhid (Oneness of Allah)",
        "description_ar": "الإيمان بوحدانية الله في ذاته وصفاته وأفعاله وعبادته",
        "description_en": "Belief in the absolute oneness of Allah in His essence, attributes, actions, and worship",
        "category": "العقيدة",
        "verses": [
            (2, 163), (2, 255), (3, 2), (3, 18), (4, 171), (6, 102), (6, 103),
            (7, 54), (7, 158), (9, 31), (9, 129), (10, 3), (12, 39), (13, 16),
            (14, 52), (16, 22), (16, 51), (17, 42), (18, 110), (20, 8), (20, 14),
            (21, 22), (21, 25), (21, 87), (23, 91), (23, 116), (27, 26), (28, 70),
            (28, 88), (35, 3), (37, 4), (38, 65), (39, 4), (40, 3), (40, 62),
            (40, 65), (41, 6), (44, 8), (47, 19), (51, 51), (57, 3), (59, 22),
            (59, 23), (59, 24), (64, 13), (112, 1), (112, 2), (112, 3), (112, 4)
        ],
        "consequences": ["هداية", "سعادة", "نجاة"],
        "causes": []
    },
    "شرك": {  # Shirk - Polytheism
        "name_en": "Shirk (Polytheism)",
        "description_ar": "الإشراك بالله في العبادة أو الصفات أو الأفعال",
        "description_en": "Associating partners with Allah in worship, attributes, or actions",
        "category": "العقيدة",
        "verses": [
            (2, 22), (2, 165), (3, 64), (3, 151), (4, 36), (4, 48), (4, 116),
            (5, 72), (5, 76), (6, 1), (6, 14), (6, 22), (6, 41), (6, 56),
            (6, 71), (6, 81), (6, 88), (6, 94), (6, 136), (6, 148), (6, 151),
            (7, 33), (7, 173), (7, 190), (7, 191), (9, 31), (10, 18), (10, 28),
            (10, 66), (12, 106), (13, 16), (13, 33), (14, 30), (16, 1), (16, 3),
            (16, 35), (16, 51), (16, 54), (16, 73), (16, 86), (17, 22), (17, 39),
            (17, 56), (17, 57), (18, 38), (18, 42), (18, 52), (19, 82), (21, 22),
            (22, 31), (23, 59), (23, 91), (24, 55), (25, 2), (25, 3), (26, 92),
            (27, 59), (27, 63), (28, 62), (28, 68), (28, 71), (28, 74), (28, 87),
            (29, 8), (29, 25), (29, 65), (30, 13), (30, 28), (30, 31), (30, 33),
            (30, 40), (30, 42), (31, 13), (34, 22), (34, 27), (35, 13), (35, 14),
            (35, 40), (39, 3), (39, 8), (39, 29), (39, 36), (39, 45), (39, 64),
            (39, 65), (40, 12), (40, 42), (40, 66), (40, 73), (40, 74), (41, 6),
            (41, 9), (42, 21), (46, 4), (46, 5), (46, 6), (46, 28), (50, 26),
            (51, 51), (60, 4), (72, 2), (72, 18), (72, 20), (98, 1), (109, 1)
        ],
        "consequences": ["عذاب", "خسران", "ضلال"],
        "causes": ["كفر", "جهل"]
    },
    "إيمان": {  # Faith
        "name_en": "Iman (Faith)",
        "description_ar": "التصديق بالقلب والإقرار باللسان والعمل بالجوارح",
        "description_en": "Belief in the heart, affirmation by tongue, and action by limbs",
        "category": "العقيدة",
        "verses": [
            (2, 3), (2, 4), (2, 8), (2, 62), (2, 82), (2, 136), (2, 177),
            (2, 183), (2, 256), (2, 285), (3, 7), (3, 16), (3, 52), (3, 84),
            (3, 110), (3, 173), (3, 179), (4, 59), (4, 136), (4, 152), (4, 162),
            (4, 171), (5, 1), (5, 54), (5, 111), (6, 82), (6, 158), (7, 2),
            (7, 87), (7, 158), (8, 2), (8, 3), (8, 4), (8, 74), (9, 18),
            (9, 23), (9, 71), (9, 112), (10, 9), (10, 63), (10, 84), (11, 23),
            (13, 28), (14, 23), (14, 27), (16, 97), (16, 99), (16, 102),
            (16, 106), (18, 2), (18, 30), (18, 107), (19, 96), (21, 94),
            (22, 14), (22, 23), (22, 50), (22, 54), (22, 56), (22, 77),
            (23, 1), (24, 47), (24, 51), (24, 55), (24, 62), (25, 70),
            (26, 51), (26, 89), (26, 199), (28, 53), (29, 2), (29, 11),
            (29, 52), (29, 58), (30, 4), (30, 56), (31, 4), (32, 15),
            (32, 19), (33, 22), (33, 35), (33, 36), (33, 43), (34, 37),
            (35, 7), (37, 29), (37, 148), (38, 28), (39, 9), (40, 7),
            (40, 40), (40, 58), (41, 8), (41, 18), (42, 18), (42, 22),
            (42, 23), (42, 26), (42, 36), (42, 45), (42, 52), (45, 3),
            (45, 14), (45, 21), (45, 30), (46, 10), (46, 13), (47, 2),
            (47, 12), (47, 19), (48, 4), (48, 5), (48, 18), (48, 29),
            (49, 7), (49, 9), (49, 14), (49, 15), (49, 17), (51, 35),
            (51, 55), (52, 21), (53, 32), (57, 7), (57, 8), (57, 12),
            (57, 19), (57, 21), (57, 28), (58, 10), (58, 22), (60, 10),
            (61, 11), (64, 8), (64, 9), (64, 11), (65, 10), (65, 11),
            (66, 8), (67, 12), (71, 28), (72, 2), (72, 13), (74, 31),
            (76, 3), (84, 25), (85, 11), (95, 6), (98, 7), (103, 3)
        ],
        "consequences": ["جنة", "رحمة", "هداية", "سعادة"],
        "causes": ["توحيد", "تقوى"]
    },
    "كفر": {  # Disbelief
        "name_en": "Kufr (Disbelief)",
        "description_ar": "إنكار ما يجب الإيمان به من أركان الإيمان",
        "description_en": "Denial of what is obligatory to believe from the pillars of faith",
        "category": "العقيدة",
        "verses": [
            (2, 6), (2, 7), (2, 24), (2, 39), (2, 89), (2, 90), (2, 98),
            (2, 161), (2, 171), (2, 212), (2, 217), (2, 254), (2, 257),
            (3, 4), (3, 10), (3, 12), (3, 21), (3, 56), (3, 86), (3, 90),
            (3, 91), (3, 106), (3, 112), (3, 116), (3, 131), (3, 147),
            (3, 151), (3, 176), (3, 177), (3, 178), (3, 196), (4, 56),
            (4, 137), (4, 140), (4, 150), (4, 151), (4, 167), (4, 168),
            (5, 10), (5, 36), (5, 44), (5, 57), (5, 68), (5, 72), (5, 73),
            (6, 7), (6, 21), (6, 49), (6, 70), (6, 93), (6, 130), (7, 37),
            (7, 40), (7, 45), (7, 50), (7, 147), (8, 36), (8, 50), (8, 55),
            (9, 3), (9, 37), (9, 68), (9, 80), (9, 84), (9, 95), (9, 125),
            (10, 4), (10, 8), (10, 69), (10, 70), (11, 17), (13, 5), (13, 35),
            (14, 2), (14, 18), (14, 28), (16, 22), (16, 39), (16, 55),
            (16, 72), (16, 83), (16, 88), (16, 104), (16, 107), (17, 8),
            (17, 10), (17, 97), (17, 98), (18, 29), (18, 56), (18, 102),
            (18, 105), (18, 106), (19, 37), (19, 73), (19, 82), (20, 126),
            (20, 127), (21, 39), (22, 19), (22, 25), (22, 55), (22, 57),
            (22, 72), (24, 39), (24, 55), (24, 57), (25, 52), (26, 201),
            (27, 4), (28, 86), (29, 23), (29, 47), (29, 52), (29, 54),
            (29, 68), (30, 8), (30, 10), (30, 16), (31, 6), (31, 7),
            (31, 23), (32, 10), (32, 29), (33, 8), (33, 64), (34, 3),
            (34, 5), (34, 17), (34, 31), (34, 33), (34, 42), (35, 7),
            (35, 26), (35, 36), (36, 64), (37, 18), (37, 68), (38, 27),
            (39, 32), (39, 59), (39, 71), (40, 4), (40, 6), (40, 10),
            (40, 22), (40, 50), (40, 71), (40, 84), (40, 85), (41, 27),
            (41, 28), (41, 41), (42, 26), (43, 65), (45, 7), (45, 8),
            (45, 11), (45, 31), (45, 32), (46, 6), (46, 11), (46, 20),
            (46, 34), (47, 8), (47, 10), (47, 11), (47, 12), (47, 32),
            (47, 34), (48, 6), (48, 13), (48, 25), (57, 15), (57, 19),
            (58, 4), (58, 5), (60, 1), (60, 13), (61, 8), (63, 3),
            (64, 10), (66, 7), (67, 6), (67, 28), (71, 26), (73, 17),
            (74, 10), (76, 4), (78, 40), (80, 42), (83, 34), (84, 22),
            (84, 24), (85, 19), (88, 23), (98, 1), (98, 6)
        ],
        "consequences": ["نار", "عذاب", "خسران"],
        "causes": ["شرك", "كبر", "جحود"]
    }
}

def main():
    engine = create_engine(settings.database_url)

    with engine.connect() as conn:
        for theme_ar, data in CORE_THEMES.items():
            # Check if theme exists
            result = conn.execute(
                text("SELECT id FROM themes WHERE name_ar = :name"),
                {"name": theme_ar}
            ).fetchone()

            if result:
                theme_id = result[0]
                print(f"Updating theme: {theme_ar} (ID: {theme_id})")

                # Update description
                conn.execute(
                    text("""UPDATE themes SET
                        description_ar = :desc_ar,
                        description_en = :desc_en
                        WHERE id = :id"""),
                    {"desc_ar": data["description_ar"],
                     "desc_en": data["description_en"],
                     "id": theme_id}
                )
            else:
                print(f"Creating theme: {theme_ar}")
                result = conn.execute(
                    text("""INSERT INTO themes (name_ar, name_en, description_ar, description_en)
                        VALUES (:name_ar, :name_en, :desc_ar, :desc_en)
                        RETURNING id"""),
                    {"name_ar": theme_ar, "name_en": data["name_en"],
                     "desc_ar": data["description_ar"], "desc_en": data["description_en"]}
                ).fetchone()
                theme_id = result[0]

            # Add verse associations
            for surah, ayah in data["verses"]:
                # Get verse_id
                verse = conn.execute(
                    text("SELECT id FROM verses WHERE surah_num = :s AND ayah_num = :a"),
                    {"s": surah, "a": ayah}
                ).fetchone()

                if verse:
                    # Check if association exists
                    exists = conn.execute(
                        text("SELECT 1 FROM verse_themes WHERE verse_id = :v AND theme_id = :t"),
                        {"v": verse[0], "t": theme_id}
                    ).fetchone()

                    if not exists:
                        conn.execute(
                            text("INSERT INTO verse_themes (verse_id, theme_id) VALUES (:v, :t)"),
                            {"v": verse[0], "t": theme_id}
                        )

            print(f"  Added {len(data['verses'])} verses")

        conn.commit()
        print("\nPart 1 complete: Core theological themes enhanced")

if __name__ == "__main__":
    main()
